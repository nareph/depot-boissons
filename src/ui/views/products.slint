// src/ui/views/products_view.slint 
import { StandardTableView, ScrollView, Button, LineEdit, ComboBox } from "std-widgets.slint";
import { ProductUI } from "../components/models.slint";

export component ProductsView inherits VerticalLayout {
    in property <[ProductUI]> products_model;
    in property <bool> is_admin;
    in property <int> current_page: 1;
    in property <int> total_pages: 1;
    in property <int> total_products: 0;
    in property <int> products_per_page: 10;
    in property <string> search_query: "";
    in property <string> stock_filter: "all"; // "all", "in_stock", "out_of_stock"
    in property <string> sort_by: "name"; // "name", "stock", "price"
    in property <string> sort_order: "asc"; // "asc", "desc"
    
    callback request_products();
    callback add_product_clicked();
    callback edit_product_clicked(string);
    callback delete_product_clicked(string, string);
    callback search_products(string);
    callback filter_products(string);
    callback sort_products(string, string);
    callback change_page(int);
    callback change_page_size(int);

    padding: 25px;
    spacing: 15px;

    // En-t√™te avec titre et actions
    HorizontalLayout {
        spacing: 15px;
        alignment: stretch;
        
        Text { 
            text: "Gestion des Produits"; 
            font-size: 28px; 
            font-weight: 700; 
            color: white;
            vertical-alignment: center;
        }
        
        Rectangle { 
            // Spacer pour pousser les boutons √† droite
        }
        
        // Actions r√©serv√©es aux administrateurs
        if root.is_admin : HorizontalLayout {
            spacing: 10px;
            alignment: end;
            
            Button { 
                text: "‚ûï Ajouter";
                height: 40px; 
                min-width: 120px;
                primary: true;
                clicked => { root.add_product_clicked(); } 
            }
        }
        
        Button { 
            text: "üîÑ Rafra√Æchir";
            height: 40px; 
            min-width: 120px; 
            clicked => { root.request_products(); } 
        }
    }

    // Barre de recherche et filtres
    Rectangle {
        height: 60px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        
        HorizontalLayout {
            padding: 15px;
            spacing: 15px;
            alignment: space-around;
            
            // Recherche
            Rectangle {
                width: 300px;
                height: 35px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                border-width: 1px;
                border-color: rgba(255, 255, 255, 0.2);
                
                HorizontalLayout {
                    padding-left: 12px;
                    padding-right: 12px;
                    spacing: 8px;
                    alignment: center;
                    
                    Text {
                        text: "üîç";
                        color: rgba(255, 255, 255, 0.6);
                        vertical-alignment: center;
                    }
                    
                    search_input := LineEdit {
                        placeholder-text: "Rechercher un produit...";
                        text: root.search_query;
                        font-size: 14px;
                        edited => {
                            root.search_products(self.text);
                        }
                    }
                }
            }

            HorizontalLayout {
                spacing: 15px;
                // Filtre par stock
                Rectangle {
                    width: 150px;
                    
                    VerticalLayout {
                        spacing: 2px;
                        
                        Text {
                            text: "Stock";
                            font-size: 12px;
                            color: rgba(255, 255, 255, 0.7);
                        }
                        
                        stock_filter_combo := ComboBox {
                            model: ["Tous", "En stock", "Rupture"];
                            current-value: root.stock_filter == "all" ? "Tous" : 
                                        root.stock_filter == "in_stock" ? "En stock" : "Rupture";
                            selected => {
                                root.filter_products(
                                    self.current-value == "Tous" ? "all" :
                                    self.current-value == "En stock" ? "in_stock" : "out_of_stock"
                                );
                            }
                        }
                    }
                }
                
                // Tri
                Rectangle {
                    width: 150px;
                    
                    VerticalLayout {
                        spacing: 2px;
                        
                        Text {
                            text: "Trier par";
                            font-size: 12px;
                            color: rgba(255, 255, 255, 0.7);
                        }
                        
                        sort_combo := ComboBox {
                            model: ["Nom ‚Üë", "Nom ‚Üì", "Stock ‚Üë", "Stock ‚Üì"];
                            current-value: root.sort_by == "name" && root.sort_order == "asc" ? "Nom ‚Üë" :
                                        root.sort_by == "name" && root.sort_order == "desc" ? "Nom ‚Üì" :
                                        root.sort_by == "stock" && root.sort_order == "asc" ? "Stock ‚Üë" : "Stock ‚Üì";
                            selected => {
                                if (self.current-value == "Nom ‚Üë") {
                                    root.sort_products("name", "asc");
                                } else if (self.current-value == "Nom ‚Üì") {
                                    root.sort_products("name", "desc");
                                } else if (self.current-value == "Stock ‚Üë") {
                                    root.sort_products("stock", "asc");
                                } else if (self.current-value == "Stock ‚Üì") {
                                    root.sort_products("stock", "desc");
                                }
                            }
                        }
                    }
                }

                Rectangle {
                    // Spacer
                }
                
                // √âl√©ments par page
                Rectangle {
                    width: 120px;
                    
                    VerticalLayout {
                        spacing: 2px;
                        
                        Text {
                            text: "Par page";
                            font-size: 12px;
                            color: rgba(255, 255, 255, 0.7);
                        }
                        
                        page_size_combo := ComboBox {
                            model: ["10", "25", "50", "100"];
                            current-value: root.products_per_page;
                            selected => {
                                root.change_page_size(self.current-value.to-float());
                            }
                        }
                    }
                }

            }
            
        }
    }

    // Information sur les r√©sultats et pagination
    HorizontalLayout {
        spacing: 15px;
        alignment: stretch;
        
        Text {
            text: root.total_products > 0 ? 
                "Affichage de " + ((root.current_page - 1) * root.products_per_page + 1) + 
                " √† " + min(root.current_page * root.products_per_page, root.total_products) + 
                " sur " + root.total_products + " produits": "" ;
               // "Aucun produit trouv√©";
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            vertical-alignment: center;
        }
        
        if root.total_products > 0 : Rectangle {
            // Spacer
        }
        
        // Contr√¥les de pagination
        if root.total_pages > 1 : HorizontalLayout {
            spacing: 8px;
            alignment: end;
            
            Button {
                text: "‚óÄ Pr√©c√©dent";
                enabled: root.current_page > 1;
                height: 32px;
                min-width: 80px;
                clicked => {
                    root.change_page(root.current_page - 1);
                }
            }
            
            Rectangle {
                width: 100px;
                height: 32px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 6px;
                
                Text {
                    text: root.current_page + " / " + root.total_pages;
                    color: white;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                    font-size: 14px;
                }
            }
            
            Button {
                text: "Suivant ‚ñ∂";
                enabled: root.current_page < root.total_pages;
                height: 32px;
                min-width: 80px;
                clicked => {
                    root.change_page(root.current_page + 1);
                }
            }
        }
    }

    // Ce Rectangle prendra tout l'espace vertical restant dans le VerticalLayout
    Rectangle {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        clip: true;

    // Message si pas de donn√©es
    if root.products_model.length == 0 : Rectangle {
        height: 200px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 16px;
        
        VerticalLayout {
            alignment: center;
            spacing: 10px;
            
            Text {
                text: "üì¶";
                font-size: 48px;
                horizontal-alignment: center;
            }
            
            Text {
                text: root.search_query != "" || root.stock_filter != "all" ? 
                     "Aucun produit ne correspond √† vos crit√®res" :
                     "Aucun produit trouv√©.\nCliquez sur 'Rafra√Æchir' pour charger les donn√©es.";
                font-size: 16px;
                color: rgba(255, 255, 255, 0.7);
                horizontal-alignment: center;
                vertical-alignment: center;
            }
            
            if root.search_query != "" || root.stock_filter != "all" : Button {
                text: "Effacer les filtres";
                height: 36px;
                clicked => {
                    search_input.text = "";
                    root.search_products("");
                    root.filter_products("all");
                }
            }
        }
    }

    // Tableau des produits 
    if root.products_model.length > 0 : Rectangle {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        clip: true;

        ScrollView {
            viewport-width: self.visible-width;
            
            VerticalLayout {
                padding: 20px;
                spacing: 2px;
                width: 100%;

                // En-t√™te du tableau responsive
                Rectangle {
                    height: 45px;
                    background: rgba(255, 255, 255, 0.15);
                    border-radius: 8px;
                    width: 100%;
                    
                    HorizontalLayout {
                        padding-left: 15px;
                        padding-right: 15px;
                        spacing: 10px;
                        
                        Rectangle {
                            horizontal-stretch: 4;
                            min-width: 200px;
                            Text { 
                                text: "Nom du Produit"; 
                                font-weight: 600; 
                                color: white; 
                                vertical-alignment: center;
                            }
                        }
                        Rectangle {
                            horizontal-stretch: 4;
                            min-width: 200px;
                            Text { 
                                text: "Stock"; 
                                font-weight: 600; 
                                color: white; 
                                horizontal-alignment: center; 
                                vertical-alignment: center;
                            }
                        }
                        Rectangle {
                            horizontal-stretch: 4;
                            min-width: 200px;
                            Text { 
                                text: "Prix"; 
                                font-weight: 600; 
                                color: white; 
                                horizontal-alignment: center; 
                                vertical-alignment: center;
                            }
                        }
                        if root.is_admin : Rectangle {
                            horizontal-stretch: 1.5;
                            min-width: 100px;
                            Text { 
                                text: "Actions"; 
                                font-weight: 600; 
                                color: white; 
                                horizontal-alignment: center; 
                                vertical-alignment: center;
                            }
                        }
                    }
                }

                // Lignes de donn√©es responsive
                for product[index] in root.products_model : Rectangle {
                    height: 55px;
                    background: mod(index, 2) == 0 ? rgba(255, 255, 255, 0.08) : rgba(255, 255, 255, 0.03);
                    border-radius: 8px;
                    width: 100%;
                    
                    // Effet hover
                    touch-area := TouchArea {
                        Rectangle {
                            background: touch-area.has-hover ? rgba(255, 255, 255, 0.15) : transparent;
                            border-radius: 8px;
                        }
                    }
                    
                    HorizontalLayout {
                        padding-left: 15px;
                        padding-right: 15px;
                        spacing: 10px;
                        
                        Rectangle {
                            horizontal-stretch: 4;
                            min-width: 200px;
                            Text { 
                                text: product.name; 
                                color: white; 
                                vertical-alignment: center;
                                wrap: word-wrap;
                                overflow: elide;
                            }
                        }
                        Rectangle {
                            horizontal-stretch: 4;
                            min-width: 200px;
                            Text { 
                                text: product.stock; 
                                color: #81C784;
                                horizontal-alignment: center; 
                                vertical-alignment: center;
                                font-weight: 600; 
                            }
                        }
                        Rectangle {
                            horizontal-stretch: 4;
                            min-width: 200px;
                            Text { 
                                text: product.price_offers; 
                                color: #FFD54F;
                                horizontal-alignment: center; 
                                vertical-alignment: center;
                                font-weight: 600; 
                                wrap: word-wrap;
                                overflow: elide;
                            }
                        }
                        
                        if root.is_admin : Rectangle {
                            horizontal-stretch: 1.5;
                            min-width: 100px;
                            
                            HorizontalLayout {
                                spacing: 8px;
                                alignment: center;
                                
                                Button {
                                    text: "‚úèÔ∏è";
                                    width: 40px;
                                    height: 32px;
                                    clicked => { root.edit_product_clicked(product.id); }
                                }

                                Button {
                                    text: "üóëÔ∏è";
                                    width: 40px;
                                    height: 32px;
                                    clicked => { root.delete_product_clicked(product.id, product.name); }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
}